import { RequestCreator, Response, Error } from "json-rpc"
import { message } from "api-error"
import node_fetch from "node-fetch"
import { token } from "stores"
import { get } from 'svelte/store';

export async function send<Req, Res>(method: string, params?: Req): Promise<Res> {
    const isBrowser = typeof window !== 'undefined';
    const fetch = isBrowser ? window.fetch : node_fetch;

    const rc = new RequestCreator(method, params);

    return await fetch(`${process.env.OCEAN_API_URL}?token=${get(token)}`, {
        method: "POST",
        body: rc.toString()
    }).then(r => r.text())
        .then((json: string) => {
            const response: Response<Res> = JSON.parse(json);

            if (response.error) {
                throw (response.error);
            } else {
                return response.result || null;
            }
        });
}

export function errorMessage(error: Error): string {
    return message(error);
}

export function setToken(value: string) {
    token.set(value || process.env.ANONYM_TOKEN);
}
